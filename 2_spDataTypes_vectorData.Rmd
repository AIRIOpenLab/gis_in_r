---
title: "Introduction to Spatial Data Types in R -- Vector Data"
output:
  html_document:
    toc: true
    toc_depth: 4
    theme: spacelab
    mathjax: default
    fig_width: 6
    fig_height: 6
---

```{r knitr_init, echo=FALSE, cache=FALSE}
library(knitr)
#library(rmdformats)

## libraries needed for R code examples
library(sp)

## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)

```

***

## 0. Set-Up
Make sure you have the `sp` library installed. If not: 

    install.packages("sp")


In addition, please install the `rgdal` library.

__On Windows:__

    install.packages("rgdal")

__On Mac:__

1. Download [GDAL complete](http://www.kyngchaos.com/files/software/frameworks/GDAL_Complete-1.11.dmg)

2. Doubleclick and install the `.dmg` file as you are used to on a Mac

3. Make sure you have R Version 3.1 installed -- if not update it.

4. Download [rgdal](http://www.kyngchaos.com/files/software/frameworks/rgdal-0.9.1-1.dmg)  

5. Doubleclick to open the `.dmg` file

6. Move `rgdal_0.9-1.tgz` to your Desktop folder

7. `install.packages("~/Desktop/rgdal_0.9-1.tgz", repos=NULL)`


Test if all went well:

    library (sp)
    library (rgdal)

***
## 1. Conceptualizing Spatial Objects in R


***
#### Exercise 1

Discuss with your neighbor: What do we need to specify in order to define spatial vector data?

* lat/lon coordinates
* projection
* attribute data
* if polygon, is it a hole or not
* ... ?

***

### How R thinks about vector data
In R the `sp` package provides classes and methods for spatial data types[^1].

Development of the `sp` began in the early 2000s in an attempt to standardize how spatial data would be treated in R and to allow for better interoparbility between different analysis packages that use spatial data. The package provides classes and methods to create _points_, _lines_, _polygons_, and _grids_ and to operate on them. It is one of the most important packages that you will need to use if dealing with spatial data in R. Many of the spatial analysis packages now use the spatial data types that are implemented in `sp` i.e. they "depend" on the `sp` package.


In `sp` spatial objects are conceptualized in the following way[^2].

The foundation object is the `Spatial` class. It has two slots (new-style class objects have pre-defined components called slots):

* a __bounding box__ 
      
* a __CRS class object__ to define the Coordinate Reference System 


## 2. Creating Spatial Objects -- The Big Picture

In order to create a spatial object manually with `sp` the basic steps are:  

>   I. Create a bunch of points, lines, or polygons (details below)

> II. Convert those to a `Spatial*` object (`*` stands for Points, Lines, or Polygons). This steps adds the bounding box (automatically) and the slot for the Coordinate Reference System or CRS (which needs to be filled manually).

> III. (_Optional_:) Add a data frame with attribute data, which will turn your `Spatial*` object into a `Spatial*DataFrame` object.


### I. Create geometric objects (topology)

R has three types of geometric objects: 

* __Points__ 
* __Lines__ 
* __Polygons__ 

### II. Create spatial objects

Geometric objects live in an abstract space (the x-y plane). To make them *spatial* objects, we also need to include information on how those x-y coordinates relate the places in the real world. When we do this, we create:

* __SpatialPoints__
* __SpatialLines__
* __SpatialPolygons__


### III. Add attributes

Sometimes we know things about our spatial objects, like the name of a river, or the population of a census region. When we add this information to our spatial data, we get:

* __SpatialPointsDataFrame__
* __SpatialLinesDataFrame__
* __SpatialPolygonsDataFrame__




[^1]: From R Bivand (2011) [Introduction to representing spatial objects in R](http://geostat-course.org/system/files/monday_slides.pdf)
[^2]: Note that this is not the only way spatial objects are conceptualized in R. Other spatial packages may use their own class definitions for spatial data (for example `spatstat). `sp` provides conversion functions for many of those formats.
[^3]: Coordinates should be of type double and will be promoted if not.


## 2. Creating a spatial objects from scratch

### 2.1 Creating Points from Scratch

Points are the most basic geometric shape, so we begin by building up a `SpatialPointsDataFrame`. 


We start with a random set of coordinates, then pass them to the `SpatialPoints` function to create our first `SpatialPoints` object:
```{r}
random.coordinates <- matrix(runif(20), ncol=2) # a matrix with some arbitrary points as coordinates..
xy.sp <- SpatialPoints(random.coordinates) # ..converted into a spatial object
plot(xy.sp, pch = 2)
```

To get a summary of how R sees these points, we can ask it for summary information in a couple different ways. Here's a summary of available commands:


method/class | and what it does
------------ | ----------------
`coordinates(x)` | returns a matrix with the spatial coordinates. For spatial polygons it returns the centroids.
`bbox(x)` | returns the bounding box (most extreme x and y coordinates)
`summary(x)` | an overview of the object, designed for human consumption
`str(x)` | an overview of the object as R sees it
`proj4string(x)` | sets or retrieves projection attributes using the CRS object.
`plot(x)` | plots a spatial object
`spplot(x)` | plots all the attributes unless specified otherwise


Let's try a few:

```{r}
coordinates(xy.sp)
bbox(xy.sp)
summary(xy.sp)
```

As noted above, while `summary` gives you a human-readable sense of an object, `str` gives you a sense of how R sees an object, so let's take a look. If this seems to alien to you, it's not important now, just something to be aware of:

```{r}
str(xy.sp)
```


#### Adding Attributes

Moving from a `SpatialPoints` to a `SpatialPointsDataFrame` occurs when you add a DataFrame of attributes to the points. Let's just add an arbitrary table to the data -- this will label each point with a letter and a number.   

```{r}
df <- data.frame(attr1 = LETTERS[1:10], attr2 = c(10:1))
```

```{r}
xy.spdf <- SpatialPointsDataFrame(xy.sp, df)
summary(xy.spdf)
```

Now that we have attributes, we can also subset our data the same way we would subset a DataFrame. Some subsetting:
```{r}
xy.spdf[1:2, ]        # row 1 and 2 only
plot(xy.spdf[which(xy.spdf$attr2>5),])    # select if attr2 > 5
```

***

### 2.2 Creating a SpatialPoint Object from a lat/lon table

A `SpatialPointsDataFrame` object can be created directly from `data.frames` by specifying which columns contain the coordinates. This is interesting, for example if you have a spreadsheet that contains latitude, longitude and some values. You an read this into a data frame with `read.table`, and then create the object from the data frame in one step by using the `coordinates()` command. That automatically turns the dataframe object into a `SpatialPointsDataFrame`:


***
####Exercise 3

1. If you haven't already, create a new directory `R_Workshop` on your Desktop. 
2. Download and unzip [`RSpatialDataTypes.zip`](https://www.dropbox.com/s/g5p8b1xi2k5lydw/RSpatialDataTypes.zip?dl=1) in this directory.
3. Set your working directory to  `R_Workshop`
4. Use `read.csv()` to read `sf_restaurant_inspections.csv` into a dataframe in R and name it `sf.df`.
5. Use `head()` to examine the first few lines of the dataframe.
6. Use `class()` to examine which object class the table belongs to.
7. Convert the table into a spatial object using the `coordinates` command and passing the names of the columns in the table that correspond to longitude and latitude:

    `coordinates(sf.df) <- c("longitude", "latitude")`

> Note the reverse order! While we usually say "latitude and longitude", since longitude corresponds to the x-coordinates on a map and latitude corresponds to the y-coodinates and R likes coordinates to be ordered (x,y), we pass `c("longitude","latitude")`!

8. Use `class()`again to examine which object class the table belongs to now:  
What to you observe?

9. Plot restaurants with terrible scores by subsetting on `Score`. 

### 2.3 A brief, but important word about projection.

Note that the Spatial object you just created __does not__ have a projection defined. It is ok to plot, but be aware that for any meaningful spatial operation you will need to define a projection. 

Projection objects can be created by passing the `CRS()` function the code associated with a known projection. You can find the codes for most commonly used projections from [www.spatialreference.org](www.spatialreference.org). 

Note that the same project can often be called in many ways. For example, one of the most commonly used projections is the WGS84 latitude-longitude projection. You can create a WGS84 lat-long projection object by either passing the reference code for the projection --  `CRS("+init=EPSG:4326"`) -- or by directly calling all its relevant parameters -- `CRS("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")`.

10. Here's an illustration of assigning a projection:
```{r eval=FALSE}
is.projected(ph.df) # see if a projection is defined  
crs.geo <- CRS("+init=EPSG:4326")  # geographical, datum WGS84
proj4string(ph.df) <- crs.geo  # define projection system of our data
```

We'll talk more about managing projections in the next lesson. 

***

### 2.4 Creating Spatial Polygons

The following example[^4] shows how a set of polygons are built from scratch. Polygons are built up from constituent parts, from `Polygon` objects to `Polygons` objects to `SpatialPolygons`. 

`Polygons` are simple geometric shapes -- squares or rectangles -- defined by a single uninterrupted line around their exterior. `Polygons` are one *or more* simple geometric objects that are inextricably linked. For example, each island in Hawaii would be a `Polygon`, but Hawaii itself is the `Polygons` consisting of all the individual islands. In addition, if you want to make a donut-shape, you have to make two simple circles -- each a `Polygon` -- where the inner circle is labeled as a `hole`, then combine them in a `Polygons`. 

Finally, you can gather a collection of `Polygons` (say, one for each state) into a `SpatialPolygons` object. If you're familiar with shapefiles, `SpatialPolygons` is basically the R analogue of a `shapefile`.

Note that the coordinates of the _Sr4_ polygon move in the opposite direction (anti-clockwise) than the other three (clockwise); it is meant to represent a hole in the _Sr3_ polygon. The default value for the hole colour is "transparent". Note that the Polygons objects have to be given character ID values, and that these values must be unique for `Polygons` objects combined in a `SpatialPolygons` object.

```{r}
# create polyon objects from coordinates
Sr1 <-  Polygon(cbind(c(2,4,4,1,2),c(2,3,5,4,2)))
Sr2 <-  Polygon(cbind(c(5,4,2,5),c(2,3,2,2)))
Sr3 <-  Polygon(cbind(c(4,4,5,10,4),c(5,3,2,5,5)))
Sr4 <-  Polygon(cbind(c(5,6,6,5,5),c(4,4,3,3,4)), hole = TRUE)

# create lists of polygon objects from polygon objects and unique ID
Srs1 <-  Polygons(list(Sr1), "s1")
Srs2 <-  Polygons(list(Sr2), "s2")
Srs3 <-  Polygons(list(Sr3, Sr4), "s3/4")

# create spatial polygons object from lists
SpP <-  SpatialPolygons(list(Srs1,Srs2,Srs3), 1:3)
plot(SpP)
```


In order to add attributes to the polygons the `row.names` of the attributes data frame are matched with the ID slots of the SpatialPolygons object, and the rows of the data frame will be re-ordered if necessary.

Add attributes:
```{r}
attr <- data.frame(attr1=1:3, attr2=3:1, row.names=c("s3/4", "s2", "s1"))
SrDf <- SpatialPolygonsDataFrame(SpP, attr)
spplot(SrDf)
```

Let's look at its structure:
```{r}
str(SrDf)
```
Whoa. 

Note that we can access the information in the slots using the `@`. For example 
```{r}
SrDf@bbox
```

To look at the attribute table, we can call the data slot:
```{r}
SrDf@data
```

[^4]:from [Edzer Pebesma Roger S. Bivand Feb 2005: S Classes and Methods for Spatial Data: the sp Package](http://cran.r-project.org/web/packages/sp/vignettes/intro_sp.pdf) 


## 3. Getting spatial data in and out of R 

The good news is that typically we do not have to create `Spatial` family objects as tediously as we did above. It is much more common that we work with already existing spatial data. 

### 3.1 How to work with `rgdal`

In order to read those into R and turn them into `Spatial*` family objects we rely on the `rgdal` package. It provides us direct access to the powerful [GDAL library](http://gdal.org) from within R. 

We can read in and write out spatial data using:

`readOGR()` and `writeOGR()` (for vector)  

The parameters provided for each function varies depending on the exact spatial file type you are reading. We will take a the ESRI shapefile as an example. A shapefile - as you know - consists of various files, and R expects all those files to be in one directory. 

When reading in a shapefile, `readOGR()` expects at least the following two arguments:

    datasource name (dsn)  # the path to the folder that contains the files
                           # Note that this is a path to the folder
    layer name (layer)     # the file name without extension
                           # Note that this is not a path but just the name of the file

For example, if I have a shapefile called `Philadelphia.shp` and all its associated files (like _.dbf, .prj, .shx_) in a directory called `PH` on my desktop, and I have my working directory set to my desktop folder, my command to read this shapefile would look like this:
```
readOGR(dsn = "sf", layer = "sf_incomes")
```
or in short:
```
readOGR("sf", "sf_incomes")
```

***
####Exercise 4

1. Load the `rgdal` package.
2. Make sure your working directory is set to the `R_Workshop` folder and it contains the materials you downloaded and unzipped earlier.
3. Read `sf_income` into an object called `sf`. Make sure you understand the directory structure.
4. Examine the file, for example with `summary()`, `class()`, `str("sf", max.level = 2)`, 
5. Take a look at the column names of the attribute data with `names(sf)`
6. Take a look at the attribute data with `head(sf@data)`
7. Note that subsetting works here: `sf[sf$MdIncHH > 40000,]` 
8. Plot some attribute data: `spplot(sf, "MdIncHH")`

***

## 4. Further resources

As of 2015-03-10 there are 134 [R packages on CRAN for reading, visualising, and analysing (geographical) spatial data](http://cran.r-project.org/web/views/Spatial.html). I recommend to visit that website if you are exploring spatial analysis with R.